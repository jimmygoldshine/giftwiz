from django.test import TestCase
from app.models import Product
from app.management.commands.ingest import Command

class IngestTest(TestCase):

    csv_data = '652286|Sports Lovers|652286|Health & Beauty|Bath & Shower~~Bath Bubbles Oils Bombs & Salts|http://click.linksynergy.com/link?id=e*uXPA8KxEg&offerid=301488.652286&type=15&murl=https%3A%2F%2Fwww.notonthehighstreet.com%2Fgumon%2Fproduct%2Fsports-lovers%3FistCompanyId%3Daa76f5e6-d733-4e56-8409-574cea196cc9%26istItemId%3Dxmxqqmpqra%26istBid%3Dt|https://cdn.notonthehighstreet.com/fs/9f/8c/1e48-a7b9-45a8-90b1-19296578e73f/original_sports-lovers.jpg||Ideal gift for a Sporty Couple. The box contains: Chamois cream (anti-chafing) 100ml; Stressed Muscle Soother gel 100ml; Energising Muscle Prep gel 100ml; Face It face cream 50ml; All in One shampoo and body bar 95g; Lemongrass and Hemp exfoliating body bar 95g. Not tested on animals Vegan friendly Paraben free No SLS No artificial fragrance or colour Chamois cream 100ml- Gum-On chamois cream is handmade in the UK from organic and natural ingredients. 100% natural herbal oils of Tea tree, Myrrh,|Ideal gift for a Sporty Couple. The box contains: Chamois cream (anti-chafing) 100ml; Stressed Muscle Soother gel 100ml; Energising Muscle Prep gel 100ml; Face It face cream 50ml; All in One shampoo and body bar 95g; Lemongrass and Hemp exfoliating body bar 95g. Not tested on animals Vegan friendly Paraben free No SLS No artificial fragrance or colour Chamois cream 100ml- Gum-On chamois cream is handmade in the UK from organic and natural ingredients. 100% natural herbal oils of Tea tree, Myrrh, Cypress with added Lemon and Lavender provide a powerful antibacterial barrier and reduce the chance of chaffing and discomfort. Stressed Muscle Soother Gel 100ml- Aloe Vera gel with a blend of highly potent essential oils of Cypress, Marjoram, Lavender and Rosemary helps to soothe tense and cramped muscles. Energising Muscle Prep 100ml- Muscle Prep gel mildly warms your muscles and ensures that you are prepared for your daily training and exercise. This non greasy formula with oils of Ginger and Balck pepper is easily absorbed within few moments and is a great tonic for your muscles. "Face It" face cream 50ml - His and Hers face cream. Face the challenges of the day with this nourishing cream. Shea butter, Aloe and 100% natural botanicals such as Myrrh, German Chamomile, Lemongrass and Lavender sooth and nourish dry, overstressed and weathered skin. More than 90% organic cream base. All in One shampoo and body bar 95g - Made with Castor oil with added Lavender and Tea Tree essential oils which are used for their antibacterial properties. This natural handmade shampoo/body bar promotes healthy hair growth, and gently moisturises skin after sporting activities. Lemongrass and Hemp exfoliating body bar 95g- Lemongrass oil is naturally deodorising, antibacterial and antiseptic. Hemp seed bran gently buffs away dead skin cells to leave your skin cleansed and smooth. After sport essential. Chamois Cream: Aqua, Helianthus annuus Seed Oil, Butyrospermum parkii Butter, Glyceryl Stearate, Theobroma cacao Seed Butter, Cera Alba, Glycerin, Sodium Stearoyl Glutamate, Sucrose Stearate, Olea europaea Fruit Oi, Linum usitatissimum Seed Oil, Aloe barbadensis Leaf Juice Powder, Coco-Glucoside, Coconut Alcohol, Tocopherol, Xanthan Gum, Lactic Acid, Dehydroacetic Acid, Benzyl Alcohol, Melaleuca Alternifolia (Tea Tree Oil), Cupressus Sumpervirens (Cypress Oil), Lavandula Angustifolia (Lavender oil), Commiphora Myrrha (Myrrh oil), Citrus Limonum (Lemon oil), Limonene, Linalool, Geraniol, Citral. *Occurring naturally in essential oils. Stressed Muscle Soother: Aqua (Water), Glycerine (Veg), Phenoxyethanol & Ethylhexylglycerin, Carbomer, Polysorbate 20, Aloe barbadensis (Aloe vera) Leaf Powder, Sodium hydroxide, Cupressus sempervirens (Cypress) Leaf Oil, Origanum majorana (Marjoram) Herb Oil, Lavendula angustifolia (Lavender) flower oil, Rosmarinus officinalis (Rosemary) Leaf Oil, Geraniol, Linalool, Limonene. *Occurring naturally in essential oils. Energising Muscle Prep: Aqua (Water), Glycerine (Veg), Phenoxyethanol & Ethylhexylglycerin, Carbomer, Polysorbate 20, Aloe barbadensis (Aloe vera) Leaf Powder, Sodium hydroxide, Zinigiber officinalis, Piper nigrum, Rosmarinus officinalis, Origanum majorana, Limonene, Linalool, Citral, Geraniol* *Occurring naturally in essential oils Face It face cream: Aqua, Helianthus annuus Seed Oil, Butyrospermum parkii Butter, Glyceryl Stearate, Theobroma cacao Seed Butter, Cera Alba, Glycerin, Sodium Stearoyl Glutamate, Sucrose Stearate, Olea europaea Fruit Oi, Linum usitatissimum Seed Oil, Aloe barbadensis Leaf Juice Powder, Coco-Glucoside, Coconut Alcohol, Tocopherol, Xanthan Gum, Lactic Acid, Dehydroacetic Acid, Benzyl Alcohol, Lavandula Angustifolia (Lavender oil), Styrax Benzoin (Benzoin oil), Cymbopogon Citratus (Lemongrass oil), Commiphora Myrrha (Myrrh oil), Matricaria Chamomilla(Chamomile oil),Citral, Linalool, Limonene, Geraniol, Citronellol, Benzyl Cinnamate, Eugenol, Benzyl Benzoate* *Occurring naturally in essential oils. All in One shampoo and body bar: Sodium cocoate, Sodium olivate, Aqua, Sodium castorate, Lavandula angustifolia (lavender) essential oil contains linalool, limonene, geraniol, Melaleuca alternifolia (tea tree) essential oil contains limonene Lemongrass and Hemp Exfoliating body bar;Sodium olivate, Sodium cocoate, Aqua, Butyrospermum parkii butter, Cymbopogon schoenanthus (lemongrass) essential oil contains citral, geraniol, limonene, citronellol, Cannabis sativa (hemp) bran||amount||42.00||||||652286|Gum-On||in-stock||60|GBP||http://ad.linksynergy.com/fs-bin/show?id=e*uXPA8KxEg&bids=301488.652286&type=15&subid=0|||||0|Adult|||||D'

    def test_extract_row(self):
        ingest = Command()
        self.assertEquals(len(ingest.extract_row(self.csv_data)), 39)

    def test_map_data_to_object(self):
        ingest = Command()
        product_data = ingest.extract_row(self.csv_data)
        product_object = ingest.data_to_object(product_data)
        self.assertEqual(product_object['name'], 'Sports Lovers')
        self.assertEqual(product_object['price'], '42.00')
        self.assertEqual(product_object['image'], 'https://cdn.notonthehighstreet.com/fs/9f/8c/1e48-a7b9-45a8-90b1-19296578e73f/original_sports-lovers.jpg')
        self.assertEqual(product_object['url'], 'http://click.linksynergy.com/link?id=e*uXPA8KxEg&offerid=301488.652286&type=15&murl=https%3A%2F%2Fwww.notonthehighstreet.com%2Fgumon%2Fproduct%2Fsports-lovers%3FistCompanyId%3Daa76f5e6-d733-4e56-8409-574cea196cc9%26istItemId%3Dxmxqqmpqra%26istBid%3Dt')

    def test_save(self):
        ingest = Command()
        product = {'id': 1, 'name': 'Paper Brooch', 'anniversary': 1, 'price': 20.5, 'image': 'https://images.manmadediy.com/k4tyv_A2hfEVyU6DyExIcpYzbqs=/800x0/filters:no_upscale()/http://s3.amazonaws.com/manmadediy-uploads-production/photos/5716/diy_paper_plane_01.jpg', 'url': 'www.test.com', 'description': 'test' }
        ingest.save_product(product)
        self.assertEqual((Product.objects.all().count()), 1)
        self.assertEqual((Product.objects.get(name='Paper Brooch').anniversary), 1)

    def test_is_new_product(self):
        ingest = Command()
        product = {'id': 1, 'name': 'Paper Brooch', 'anniversary': 1, 'price': 20.5, 'image': 'https://images.manmadediy.com/k4tyv_A2hfEVyU6DyExIcpYzbqs=/800x0/filters:no_upscale()/http://s3.amazonaws.com/manmadediy-uploads-production/photos/5716/diy_paper_plane_01.jpg', 'url': 'www.test.com', 'description': 'test' }
        product2 = {'id': 2, 'name': 'Gold Brooch', 'anniversary': 50, 'price': 200.5, 'image': 'https://images.manmadediy.com/k4tyv_A2hfEVyU6DyExIcpYzbqs=/800x0/filters:no_upscale()/http://s3.amazonaws.com/manmadediy-uploads-production/photos/5716/diy_paper_plane_01.jpg', 'url': 'www.test2.com', 'description': 'test2' }
        ingest.save_product(product)
        self.assertEqual(ingest.is_new_product(product), False)
        self.assertEqual(ingest.is_new_product(product2), True)
